name: Tangle code extracted from documentation

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["main"]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read

# Allow one concurrent test
concurrency:
  group: "tangle"
  cancel-in-progress: true

env:
  BUILD_TYPE: Release

jobs:
  # Tangle job
  tangle:
    runs-on: ubuntu-latest
    outputs:
      tangle-roots: ${{ steps.set-tangle-roots.outputs.roots }}
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Setup Pages
      uses: actions/configure-pages@v2
    - name: Setup Python
      run: pip install -r requirements.txt
    - name: Build with Sphinx
      run: make tangle
    - name: List tangle roots
      id: set-tangle-roots
      run: echo "roots=$(printf '['; find _build/tangle -maxdepth 1 -mindepth 1 -type d -printf '"%P", '; printf ']\n')" >> $GITHUB_OUTPUT
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: tangled-code
        path: _build/tangle

  # Filter unnecessary tests
  filter-unchanged:
    runs-on: ubuntu-latest
    needs: tangle
    outputs:
      tangle-roots: ${{ steps.filter-tangle-roots.outputs.roots }}
    steps:
    - name: Download current tangle
      uses: actions/download-artifact@v3
      with:
        name: tangled-code
        path: current
    - name: Download previous tangle
      uses: actions/cache/restore@v3
      id: cache
      with:
        path: previous
        key: previous-tangle
    - name: Filter out unchanged roots
      id: filter-tangle-roots
      env:
        roots: ${{ needs.filter-unchanged.outputs.tangle-roots }}
        foundPrevious: ${{ steps.cache.outputs.cache-hit }}
      run: |-
        if $foundPrevious
          # Only keep the ones that changed
          echo "roots=$(python tools/filter_unchanged_tangle_roots.py "$roots" current previous)" >> $GITHUB_OUTPUT
        else
          # Just forward the list
          echo "roots=$roots" >> $GITHUB_OUTPUT
        endif
    - name: Cache current tangle
      uses: actions/cache@v3
      with:
        path: current
        key: previous-tangle

  # Test job
  test:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        tangle-root: ${{ fromJson(needs.filter-unchanged.outputs.tangle-roots) }}
        include:
        - os: ubuntu-latest
          install-deps: |
            sudo apt-get update -y
            sudo apt-get install -y xorg-dev
        
    runs-on: ${{ matrix.os }}
    needs: [tangle, filter-unchanged]
    steps:
    - if: ${{ matrix.install-deps }}
      name: Install dependencies
      run: ${{ matrix.install-deps }}

    - name: Download artifact
      uses: actions/download-artifact@v3
      with:
        name: tangled-code

    - name: Configure CMake
      run: cmake -S "${{ matrix.tangle-root }}" -B ${{github.workspace}}/build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}

    - name: Build
      run: cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}}
